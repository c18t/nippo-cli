[env]
'_'.file = '.env'
'_'.path = './node_modules/.bin'

[tools]
node = "25"
python = "3"
container-use = "latest"
gh = "latest"
goreleaser = "latest"
jq = "latest"
pipx = "latest"
pnpm = "latest"
pre-commit = "latest"
shellcheck = "latest"
yamllint = "latest"
"aqua:hadolint" = "latest"
"go:github.com/k1LoW/octocov" = "latest"
"go:github.com/melkeydev/go-blueprint" = "latest"
"go:github.com/rhysd/actionlint/cmd/actionlint" = "latest"
"go:github.com/spf13/cobra-cli" = "latest"

[tasks.setup]
description = "Set up (Runs all `setup:*` tasks)"
depends = ["setup:mise", "setup:go-mod", "setup:pnpm", "setup:claude-mcp", "setup:pre-commit"]

[tasks."setup:mise"]
description = "Install dev dependencies with mise"
run = "mise install -y"
sources = ['.mise.toml']

[tasks."setup:go-mod"]
description = "Install go modules with go.mod"
run = "go mod download"
sources = ['go.mod']
outputs = ['go.sum']

[tasks."setup:pnpm"]
description = "Set up pnpm packages"
depends = ["setup:mise"]
run = "pnpm install"
sources = ['package.json', 'pnpm-lock.yaml', '.mise.toml']
outputs = ['node_modules/.pnpm/lock.yaml']

[tasks."setup:claude-mcp"]
description = "Set up Claude Code MCP servers"
run = """
#!/usr/bin/env -S bash -euo pipefail
SETTING=.claude/settings.local.json
if [ ! -e "${SETTING}" ]; then
  cp .claude/settings.local.template.json .claude/settings.local.json
fi
MCP=$(jq -r ".mcpServers | keys" .mcp.json)
TMPFILE=$(mktemp)
jq .enabledMcpjsonServers="${MCP}" ${SETTING} > ${TMPFILE} && mv ${TMPFILE} ${SETTING}
echo "enabled MCP servers: ${MCP}"
"""

[tasks."setup:pre-commit"]
description = "Set up pre-commit hooks"
depends = ["setup:mise"]
run = "pre-commit install"
sources = ['.pre-commit-config.yaml']
outputs = ['.git/hooks/pre-commit']

[tasks.build]
description = "Build the CLI application"
alias = "b"
run = "make"
sources = ["go.mod", "main.go", "cmd/**/*.go", "internal/**/*.go"]
outputs = ["bin/app"]

[tasks.release]
description = "Build release binaries"
alias = "r"
run = "goreleaser release --snapshot --clean"

[tasks.devcontainer-up]
description = "Start devcontainer and run ccmanager with Claude Code"
alias = "dev-up"
run = """
#!/usr/bin/env -S bash -euo pipefail
if [ "${DEVCONTAINER:-false}" == "true" ]; then
  mise run dev-up:claude-code-stop-autoupdates
  mise run dev-up:ccmanager-skip-permissions
  mise run dev-up:ccmanager-worktree-settings
  ccmanager
else
  ccmanager --devc-up-command 'devcontainer up --workspace-folder .' --devc-exec-command 'devcontainer exec --workspace-folder . -- claude --dangerously-skip-permissions'
fi
"""

[tasks."dev-up:claude-code-stop-autoupdates"]
description = "Set up Claude Code to disable auto-updates"
run = """
#!/usr/bin/env -S bash -euo pipefail
if [ "${DEVCONTAINER:-false}" != "true" ]; then
  echo 'YOU ARE NOT IN DEVCONTAINER. Abort.'
  exit 1
fi
SETTING=~/.claude.json
if [ ! -e ${SETTING} ]; then
  claude --help 2>&1 >/dev/null
fi
TMPFILE=$(mktemp)
jq '.autoInstallIdeExtension=false|.autoUpdates=false' ${SETTING} > ${TMPFILE} && mv ${TMPFILE} ${SETTING}
echo 'disabled claude code autoupdates and extension installation'
"""

[tasks."dev-up:ccmanager-skip-permissions"]
description = "Set up ccmanager to skip permissions"
run = """
#!/usr/bin/env -S bash -euo pipefail
if [ "${DEVCONTAINER:-false}" != "true" ]; then
  echo 'YOU ARE NOT IN DEVCONTAINER. Abort.'
  exit 1
fi
SETTING=~/.config/ccmanager/config.json
if [ ! -e ${SETTING} ]; then
  ccmanager --help 2>&1 >/dev/null
fi
TMPFILE=$(mktemp)
jq .commandPresets.presets[0].args='["--dangerously-skip-permissions"]' ${SETTING} > ${TMPFILE} && mv ${TMPFILE} ${SETTING}
echo 'made ccmanager skip permissions'
"""

[tasks."dev-up:ccmanager-worktree-settings"]
description = "Set up ccmanager worktree auto-directory settings"
run = """
#!/usr/bin/env -S bash -euo pipefail
if [ "${DEVCONTAINER:-false}" != "true" ]; then
  echo 'YOU ARE NOT IN DEVCONTAINER. Abort.'
  exit 1
fi
SETTING=~/.config/ccmanager/config.json
if [ ! -e ${SETTING} ]; then
  ccmanager --help 2>&1 >/dev/null
fi
TMPFILE=$(mktemp)
jq '.worktree.autoDirectory=true|.worktree.autoDirectoryPattern="../{project}-{branch}"' \
  ${SETTING} > ${TMPFILE} && mv ${TMPFILE} ${SETTING}
echo 'configured ccmanager worktree auto-directory settings'
"""
